

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bgfc_kit.fir_design_matrix &mdash; BGFCkit Documentation 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> BGFCkit Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">bgfc_kit</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BGFCkit Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>bgfc_kit.fir_design_matrix</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for bgfc_kit.fir_design_matrix</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">toml</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">.structDict</span> <span class="kn">import</span> <span class="n">recurseCreateStructDict</span>


<div class="viewcode-block" id="generate_FIRdesignMat_template_toml"><a class="viewcode-back" href="../../bgfc_kit.html#bgfc_kit.fir_design_matrix.generate_FIRdesignMat_template_toml">[docs]</a><span class="k">def</span> <span class="nf">generate_FIRdesignMat_template_toml</span><span class="p">(</span><span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;This function generates the configuration file for constructing FIR design matrix at the specified output directory. You need to specify all the parameters listed below in order to build the FIR design matrix for your need. You can refer to the comments below for more information regarding each parameter. If you do not need to account for motion (i.e., running only &#39;write_vanilla_FIRdesginMat&#39;), you won&#39;t need to fill out anything below &#39;epoch_per_run&#39;.</span>
<span class="sd">    </span>
<span class="sd">    Function parameters</span>
<span class="sd">    --------------------</span>
<span class="sd">    output_dir : str</span>
<span class="sd">        Where the template configuration file will be created at. </span>

<span class="sd">    Configuration parameters</span>
<span class="sd">    ------------------------</span>
<span class="sd">    conditions : </span>
<span class="sd">        A list of conditions; The order should be IDENTICAL to how they will be concatenated when running the GLMs.</span>
<span class="sd">    rep : </span>
<span class="sd">        The number of runs each condition is repeated.</span>
<span class="sd">    fir_regressors : </span>
<span class="sd">        The name of the regressors (e.g., A TR within a block is usually one of the 3 components: instruction, task, and IBI), the names are only for clarity. The regressors do not need to cover the entire block. For example, you can only modle the first 36 TRs for each 40 TR block. </span>
<span class="sd">    epoch_tr : </span>
<span class="sd">        The number of TR within each block/epoch.</span>
<span class="sd">    run_leadingin_tr : </span>
<span class="sd">        The number of leading in TR.</span>
<span class="sd">    run_leadingout_tr : </span>
<span class="sd">        The number of leading out TR.</span>
<span class="sd">    epoch_per_run : </span>
<span class="sd">        The number of blocks/epochs within each run.</span>
<span class="sd">    fmriprep_dir : </span>
<span class="sd">        Where fmriprep derivative is located.</span>
<span class="sd">    spike_cutoff : </span>
<span class="sd">        The threshold to ignore a frame in the designmatrix.</span>
<span class="sd">    prop_spike_cutoff : </span>
<span class="sd">        Between 0 and 100, if the percentage of frames within a run has fd &gt; fd_cutoff is greater than prop_spike_cutoff, then remove the run.</span>
<span class="sd">    sub_id : </span>
<span class="sd">        Subject id, naming convention should follow how the subject folder is named in the fMRIprep derivative folder, do not need to include the &#39;sub-&#39; prefix. </span>
<span class="sd">    order : </span>
<span class="sd">        This is a dictionary, with keys being the name of the run and values being its order. This is necessary to locate all the confound files in the derivative folder and to sort them in the same order as they will be concatenated and modeled. The name of a fMRIprep output confound file is sub-%s_task-%s_run-%s_desc-preproc_bold.nii, the keys here need to be specified as&#39;task-%s_run-%s&#39;. For example, &#39;task-divPerFacePerTone_run-2&#39;. </span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The length of each run should be run_leadingin_tr + epoch_per_run*epoch_tr + run_leadingout_tr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        
        <span class="s2">&quot;HOW TO USE&quot;</span><span class="p">:</span><span class="s2">&quot;This is the configuration file for constructing FIR design matrix. You need to specify all the parameters listed below in order to build the FIR design matrix for your need. You can refer to the comments below for more information regarding each parameter. If you do not need to account for motion (i.e., running only &#39;write_vanilla_FIRdesginMat&#39;), you won&#39;t need to fill out anything below &#39;epoch_per_run&#39;.&quot;</span>

        <span class="p">,</span><span class="s2">&quot;PARAMETERS&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">,</span><span class="s2">&quot;rep&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
            <span class="p">,</span><span class="s2">&quot;fir_regressors&quot;</span><span class="p">:</span> <span class="p">[]</span> 
            <span class="p">,</span><span class="s2">&quot;epoch_tr&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;run_leadingin_tr&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;run_leadingout_tr&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;epoch_per_run&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;fmriprep_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;fd_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
            <span class="p">,</span><span class="s2">&quot;spike_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;prop_spike_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;sub_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span> 
        <span class="p">}</span>
        
        <span class="p">,</span><span class="s2">&quot;COMMENTS&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="s2">&quot;A list of conditions; The order should be IDENTICAL to how they will be concatenated when running the GLMs.&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;rep&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of runs each condition is repeated&quot;</span>
            <span class="p">,</span><span class="s2">&quot;fir_regressors&quot;</span><span class="p">:</span> <span class="s2">&quot;The name of the regressors (e.g., A TR within a block is usually one of the 3 components: instruction, task, and IBI), the names are only for clarity. The regressors do not need to cover the entire block. For example, you can only modle the first 36 TRs for each 40 TR block&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;epoch_tr&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of TR within each block/epoch&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;run_leadingin_tr&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of leading in TR&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;run_leadingout_tr&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of leading out TR&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;epoch_per_run&quot;</span><span class="p">:</span> <span class="s2">&quot;The number of blocks/epochs within each run&quot;</span> 
            <span class="p">,</span><span class="s2">&quot;fmriprep_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;Where fmriprep derivative folder is located&quot;</span>  
            <span class="p">,</span><span class="s2">&quot;fd_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;if the percentage of frames within a run has fd &gt; fd_cutoff is greater than prop_spike_cutoff, then remove the run&quot;</span>
            <span class="p">,</span><span class="s2">&quot;spike_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;the threshold to ignore a frame in the designmatrix &quot;</span> 
            <span class="p">,</span><span class="s2">&quot;prop_spike_cutoff&quot;</span><span class="p">:</span> <span class="s2">&quot;between 0 and 100, if the percentage of frames within a run has fd &gt; fd_cutoff is greater than prop_spike_cutoff, then remove the run&quot;</span>
            <span class="p">,</span><span class="s2">&quot;sub_id&quot;</span><span class="p">:</span> <span class="s2">&quot;subject id, naming convention should follow how the subject folder is named in the fMRIprep derivative folder, do not need to include the &#39;sub-&#39; prefix&quot;</span>
            <span class="p">,</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;this is a dictionary, with keys being the name of the run and values being its order. This is necessary to locate all the confound files in the derivative folder and to sort them in the same order as they will be concatenated and modeled. The name of a fMRIprep output confound file is sub-</span><span class="si">%s</span><span class="s2">_task-</span><span class="si">%s</span><span class="s2">_run-</span><span class="si">%s</span><span class="s2">_desc-preproc_bold.nii, the keys here need to be specified as&#39;task-</span><span class="si">%s</span><span class="s2">_run-</span><span class="si">%s</span><span class="s2">&#39;. For example, &#39;task-divPerFacePerTone_run-2&#39;&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Write the data to the TOML file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="s2">&quot;FIRdesignMat_conf.toml&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">toml_file</span><span class="p">:</span>
        <span class="n">toml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">toml_file</span><span class="p">)</span></div>
        
<span class="k">def</span> <span class="nf">_generate_vanilla_designMat</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> 
    
    <span class="sd">&quot;&quot;&quot;This function generates the vanilla design matrix for all subjects, not accounting for motion or bad runs. This function is specifically aiming for block designed, FIR design matrix. This is for all subjects since it requires the fMRI runs to be concatenated in the same order across all subjects, although they were run in different order in the scanner. Moreover, the runs should be identical to each other and all blocks within in a run are of the same condition. Make sure to name the runs by the conditions during the R&amp;D session, so later you will know the condition of each scan, which makes everything a lot easier. </span>
<span class="sd">    Each FIR regressor models a specific &quot;type&quot; of TR. For example, a FIR regressor may model the first TR of every block/epoch of condition1. You may chose to model all TR within a block, or chose to model a subset of TRs. For example, if a block/epoch has 40 TRs in total, you can chose to model the first 36 TRs thats totally fine. As a result, you end up having (#_of_conditions * #_of TRs_modeled) number of regressors. </span>
<span class="sd">    The final design matrix has the shape (total_#_of_TR_all_scans * #_of_regressors). </span>

<span class="sd">    Parameter:</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg_dir: the path for the toml configuration file. </span>
<span class="sd">    </span>
<span class="sd">    Outputs:</span>
<span class="sd">    --------</span>
<span class="sd">    full_fir: numpy array </span>
<span class="sd">    all_regressors: list of regressor names. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load configuration file </span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">toml_file</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">toml_file</span><span class="p">)</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">recurseCreateStructDict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMETERS</span>

    <span class="c1"># combine task and regressor names to get all regressor (#_of_conditions * #_of TRs_modeled)</span>
    <span class="n">all_regressors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">this_task</span><span class="p">,</span> <span class="n">this_reg</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fir_regressors</span><span class="p">):</span>
        <span class="n">all_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_task</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">this_reg</span><span class="p">)</span>

    <span class="c1"># FIR design matrix for each condition (each condition may contain multiple runs)</span>
    <span class="n">per_block_fir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">epoch_tr</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">fir_regressors</span><span class="p">))</span> <span class="c1"># for each block (block structures should be all identical)</span>
    <span class="n">leadingin_dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">run_leadingin_tr</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">fir_regressors</span><span class="p">)])</span> <span class="c1"># leading in TRs, </span>
    <span class="n">leadingout_dummy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">run_leadingout_tr</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">fir_regressors</span><span class="p">)])</span> <span class="c1"># leading out TRs, </span>
    <span class="n">run_struct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">epoch_per_run</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># the structure of a run, in terms of blocks </span>
    <span class="n">per_run_fir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">run_struct</span><span class="p">,</span><span class="n">per_block_fir</span><span class="p">)</span>
    <span class="n">per_run_fir_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">leadingin_dummy</span><span class="p">,</span> <span class="n">per_run_fir</span><span class="p">,</span> <span class="n">leadingout_dummy</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># design matrix for a run</span>
    <span class="n">per_run_fir_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">per_run_fir_full</span><span class="p">]</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">rep</span><span class="p">)</span> <span class="c1"># design matrix for a condition</span>
    
    <span class="c1"># Each condition should have the same structure     </span>
    <span class="n">task_struct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">conditions</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">conditions</span><span class="p">))</span> 
    <span class="n">full_fir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">task_struct</span><span class="p">,</span> <span class="n">per_run_fir_full</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">full_fir</span><span class="p">,</span> <span class="n">all_regressors</span>
    

<div class="viewcode-block" id="write_vanilla_FIRdesginMat"><a class="viewcode-back" href="../../bgfc_kit.html#bgfc_kit.fir_design_matrix.write_vanilla_FIRdesginMat">[docs]</a><span class="k">def</span> <span class="nf">write_vanilla_FIRdesginMat</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> 

    <span class="sd">&quot;&quot;&quot;This function writes out the vanilla FIR design matrix to the output_dir. It also plots it out so you can eyeball the structure to make sure it looks correct. This function assumes the functional scans were ordered in the same way across the subjects even though they were run in different orders. This can easily be achieved by naming your EPI runs during the R&amp;D session. As a result, this function generates the design matrix that works for all participants.</span>
<span class="sd">    </span>
<span class="sd">    :param cfg_dir: str </span>
<span class="sd">        The path for the toml configuration file. </span>
<span class="sd">    :param output_dir: str</span>
<span class="sd">        Where the text file and heatmap will be created at. </span>
<span class="sd">    </span>
<span class="sd">    :return: None</span>

<span class="sd">    :notes:</span>
<span class="sd">        This function does not account for spikes or bad runs, thus being &#39;vanilla&#39;.</span>
<span class="sd">        This function writes out fir_design_matrix.txt, which is finite impulse response (FIR) model design matrix, and fir_design_heatmap.png, which is the heatmap of the design matrix. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># generate vanilla fir matrix</span>
    <span class="n">vanilla_fir</span><span class="p">,</span> <span class="n">all_regressors</span> <span class="o">=</span> <span class="n">_generate_vanilla_designMat</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">)</span>
    
    <span class="c1"># write it out </span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vanilla_fir</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">all_regressors</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="s1">&#39;fir_design_matrix.txt&#39;</span><span class="p">),</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="c1"># plot it </span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="s1">&#39;fir_design_heatmap.png&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="write_personalized_FIRdesginMat"><a class="viewcode-back" href="../../bgfc_kit.html#bgfc_kit.fir_design_matrix.write_personalized_FIRdesginMat">[docs]</a><span class="k">def</span> <span class="nf">write_personalized_FIRdesginMat</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> 
    
    <span class="sd">&quot;&quot;&quot;This function personlize FIR design matrix for each participant, aims to remove bad runs and bad frames from the FIR model. Bad runs and bad frames were defined based on the framewise-displacement confound outputed by fMRIprep. The implementation here is that, </span>
<span class="sd">    1) if more than prop_spike_cutoff (e.g., 5%) of frames with in a run has fd &gt; fd_cutoff (e.g., 0.5), then all regressors will be 0 for all TRs within this run, </span>
<span class="sd">    2) if the run is good, then look at each frame, if the frame has fd &gt; spike_cutoff (e.g., 2), then all regressors of this frame and its preceding and following frames will be 0. </span>
<span class="sd">    </span>
<span class="sd">    Parameter:</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg_dir: </span>
<span class="sd">        The path for the toml configuration file. </span>
<span class="sd">    output_dir: </span>
<span class="sd">        Where the text file and heatmap will be created at. </span>
<span class="sd">    </span>
<span class="sd">    Yield:</span>
<span class="sd">    -------</span>
<span class="sd">    fir_design_matrix.txt: finite impulse response (FIR) model design matrix for a specific subject, accounting for motion.</span>
<span class="sd">    fir_design_heatmap.png: heatmap of the design matrix. </span>

<span class="sd">    Note: </span>
<span class="sd">    ------</span>
<span class="sd">    This function generates FIR design matrix customized for each subject, removing spikes and bad runs (due to motion).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># -----------------------</span>
    <span class="c1"># load configuration file and check required field from the configuration file </span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">toml_file</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">toml_file</span><span class="p">)</span>
    <span class="n">required_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fmriprep_dir&quot;</span><span class="p">,</span><span class="s2">&quot;fd_cutoff&quot;</span><span class="p">,</span><span class="s2">&quot;spike_cutoff&quot;</span><span class="p">,</span><span class="s2">&quot;prop_spike_cutoff&quot;</span><span class="p">,</span><span class="s2">&quot;sub_id&quot;</span><span class="p">,</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">required_fields</span><span class="p">:</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;PARAMETERS&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]:</span> 
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{f}</span><span class="s2"> not specified in the configuration file&quot;</span><span class="p">)</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">recurseCreateStructDict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">PARAMETERS</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
    
    <span class="c1"># -----------------------</span>
    <span class="c1"># get confound files for the participant, order it as how 12 runs are being concatenated. </span>
    <span class="n">fir_design_matrix</span><span class="p">,</span> <span class="n">all_regressors</span> <span class="o">=</span> <span class="n">_generate_vanilla_designMat</span><span class="p">(</span><span class="n">cfg_dir</span><span class="p">)</span>
    <span class="n">sub_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">fmriprep_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{cfg.sub_id}</span><span class="s1">/func&#39;</span><span class="p">)</span>
    <span class="n">confound_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="s2">&quot;*_run-*_desc-confounds_timeseries.tsv&quot;</span><span class="p">))</span> <span class="c1"># this is the standard format of fmriprep so should be generalizable</span>
    <span class="c1"># the standard format is sub-%s_task-%s_run-%s_desc-preproc_bold.nii, </span>
    <span class="c1"># so by doing x.split(&quot;_&quot;)[1:3], I carve out &#39;task-%s_run-%s&#39;, </span>
    <span class="c1"># so make sure you have the keys in this way when passing in the order. </span>
    <span class="c1"># sort it as how the runs will be concatenated. </span>
    <span class="n">confound_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])])</span> 
    
    <span class="c1"># -----------------------</span>
    <span class="c1"># Look for spikes or bad motion runs. </span>
    <span class="c1"># len(ts)=total_#_of_TR_all_scans, if 0, then remove the corresponding column in the FIR matrix. </span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">confound_files</span><span class="p">:</span> 
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">motion</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;framewise_displacement&#39;</span><span class="p">])</span> <span class="c1"># get FD from the fMRIprep confound file. </span>
        <span class="n">outlier_prop</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">motion</span><span class="p">)</span><span class="o">&gt;</span><span class="n">cfg</span><span class="o">.</span><span class="n">fd_cutoff</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">motion</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># %of frames that have FD&gt;0.5</span>
        
        <span class="k">if</span> <span class="n">outlier_prop</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">prop_spike_cutoff</span><span class="p">:</span> <span class="c1"># remove the whole run (all frames are bad frames) </span>
            <span class="n">ts_run</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motion</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise look for spike </span>
            <span class="n">ts_run</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">motion</span><span class="p">))]</span> <span class="c1"># at the beginning, all timepoints are good frames. </span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">motion</span><span class="p">):</span> 
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">spike_cutoff</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># if this is the frist frame (motion is np.nan for the first frame) or not a spike </span>
                <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">spike_cutoff</span><span class="p">:</span> <span class="c1"># if spike </span>
                    <span class="n">ts_run</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ts_run</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="c1"># remove the previous and the current frame </span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">motion</span><span class="p">):</span> <span class="c1"># if not the last frame, remove the next frame </span>
                        <span class="n">ts_run</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">ts</span> <span class="o">+=</span> <span class="n">ts_run</span> 
    
    <span class="c1"># -----------------------</span>
    <span class="c1"># remove spikes or bad motion runs. </span>
    <span class="c1"># if bad frame, remove the frame from FIR design matrix (all 0 for all regressors) </span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="k">pass</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">fir_design_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">0</span> 
    
    <span class="c1"># write it out </span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fir_design_matrix</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">all_regressors</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{cfg.sub_id}</span><span class="s1">_fir_design_matrix.txt&#39;</span><span class="p">),</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="c1"># plot it </span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{cfg.sub_id}</span><span class="s1">_fir_design_heatmap.png&#39;</span><span class="p">))</span></div>
  
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2023, Peeta Li

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>